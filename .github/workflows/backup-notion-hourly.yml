name: Notion API Backup (No Cookies)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install notion-client markdownify pandas

      - name: Backup Notion Pages & Dbs
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}  # ← your secret_... token
        run: |
          python - <<EOF
          import os
          from notion_client import Client
          from pathlib import Path
          import pandas as pd
          import json

          notion = Client(auth=os.environ["NOTION_TOKEN"])

          database_ids = [
              "2fe86657637a80709d98e8848581f4c7",   # Campus International Maroc’s Hub CRM
              "2fe86657637a80cc8410f9e45f444435"    # Goal Tracker CRM
          ]

          output_dir = Path("notion-backup")
          output_dir.mkdir(exist_ok=True)

          for db_id in database_ids:
              try:
                  # Get database metadata (title, properties)
                  db = notion.databases.retrieve(database_id=db_id)
                  title = db["title"][0]["plain_text"] if db["title"] else "Untitled Database"

                  # Query all rows (add filters/pagination if huge DB)
                  query_result = notion.databases.query(database_id=db_id)
                  rows = query_result["results"]

                  # Build simple data for CSV
                  data = []
                  for row in rows:
                      props = row["properties"]
                      row_data = {
                          "ID": row["id"],
                          "Created": row["created_time"],
                          "Last Edited": row["last_edited_time"]
                      }
                      for prop_name, prop in props.items():
                          if prop["type"] == "title":
                              row_data[prop_name] = prop["title"][0]["plain_text"] if prop["title"] else ""
                          elif prop["type"] == "rich_text":
                              row_data[prop_name] = prop["rich_text"][0]["plain_text"] if prop["rich_text"] else ""
                          elif prop["type"] == "select":
                              row_data[prop_name] = prop["select"]["name"] if prop["select"] else ""
                          elif prop["type"] == "multi_select":
                              row_data[prop_name] = ", ".join([o["name"] for o in prop["multi_select"]]) if prop["multi_select"] else ""
                          elif prop["type"] == "status":
                              row_data[prop_name] = prop["status"]["name"] if prop["status"] else ""
                          elif prop["type"] == "number":
                              row_data[prop_name] = prop["number"]
                          elif prop["type"] == "date":
                              row_data[prop_name] = prop["date"]["start"] if prop["date"] else ""
                          # Add more types as needed (checkbox, url, email, relation, etc.)
                          else:
                              row_data[prop_name] = str(prop.get(prop["type"], ""))

                      data.append(row_data)

                  if data:
                      df = pd.DataFrame(data)
                      csv_path = output_dir / f"{title.replace(' ', '_')}.csv"
                      df.to_csv(csv_path, index=False)
                      print(f"Saved CSV: {csv_path}")

                  # Optional: Save basic Markdown summary
                  md_content = f"# {title}\n\n**Database ID:** {db_id}\n**Properties:**\n"
                  for prop_name, prop in db["properties"].items():
                      md_content += f"- {prop_name} ({prop['type']})\n"
                  md_path = output_dir / f"{title.replace(' ', '_')}_summary.md"
                  md_path.write_text(md_content)
                  print(f"Saved MD summary: {md_path}")

              except Exception as e:
                  print(f"Error processing DB {db_id}: {e}")

          print("Backup complete!")
          EOF

      - name: Commit changes
        run: |
          git config user.name "Nihad-BIT"
          git config user.email "nihadNV@proton.me"
          git add notion-backup/
          git diff --staged --quiet || git commit -m "API Notion backup $(date '+%Y-%m-%d %H:%M')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
