name: Notion API Backup (Targeted CRM Scan)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install notion-client pandas

      - name: Backup Notion Data
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          python - <<'EOF'
          import os
          from notion_client import Client
          from pathlib import Path
          import pandas as pd

          # Initialize Client
          notion = Client(auth=os.environ["NOTION_TOKEN"])
          output_dir = Path("notion-backup")
          output_dir.mkdir(exist_ok=True)

          # Your specific CRM and Tracker IDs
          ROOT_IDS = [
              "2fe86657637a80709d98e8848581f4c7",  # Campus International Marocâ€™s Hub CRM
              "2fe86657637a80cc8410f9e45f444435"   # Goal Tracker CRM
          ]

          def extract_properties(row):
              props = row.get("properties", {})
              row_data = {"Page ID": row["id"], "URL": row.get("url")}
              for name, content in props.items():
                  p_type = content.get("type")
                  val = content.get(p_type)
                  
                  if p_type in ["title", "rich_text"]:
                      row_data[name] = "".join([t.get("plain_text", "") for t in val]) if val else ""
                  elif p_type == "select" and val:
                      row_data[name] = val.get("name", "")
                  elif p_type == "multi_select" and val:
                      row_data[name] = ", ".join([v.get("name", "") for v in val])
                  elif p_type == "date" and val:
                      row_data[name] = val.get("start", "")
                  elif p_type in ["number", "checkbox", "url", "email", "phone_number"]:
                      row_data[name] = val
                  else:
                      row_data[name] = str(val) if val is not None else ""
              return row_data

          def backup_database(db_id, title):
              print(f"    [FOUND] Extracting Database: {title}")
              all_rows = []
              has_more, cursor = True, None
              try:
                  while has_more:
                      # CORRECTED SYNTAX: notion.databases.query(...)
                      res = notion.databases.query(
                          **{
                              "database_id": db_id,
                              "start_cursor": cursor,
                          }
                      )
                      all_rows.extend(res["results"])
                      has_more, cursor = res["has_more"], res["next_cursor"]
                  
                  if all_rows:
                      df = pd.DataFrame([extract_properties(r) for r in all_rows])
                      safe_title = "".join(c if c.isalnum() or c in " -" else "_" for c in title).strip()
                      csv_path = output_dir / f"{safe_title}.csv"
                      df.to_csv(csv_path, index=False)
                      print(f"      -> SUCCESS: Saved {len(all_rows)} rows to {csv_path.name}")
                  else:
                      print("      -> Database is empty, skipping CSV creation.")
              except Exception as e:
                  print(f"      -> Skip: API Error ({e})")

          def scan_block(block_id):
              """Recursive crawl to find 'child_database' blocks"""
              try:
                  # 1. Try to see if the ID itself is a database first
                  try:
                      db_info = notion.databases.retrieve(database_id=block_id)
                      db_title = db_info["title"][0]["plain_text"] if db_info["title"] else "Database"
                      backup_database(block_id, db_title)
                      return 
                  except:
                      pass

                  # 2. Scan children for nested databases
                  children = notion.blocks.children.list(block_id=block_id).get("results", [])
                  for child in children:
                      if child["type"] == "child_database":
                          backup_database(child["id"], child["child_database"]["title"])
                      elif child.get("has_children"):
                          scan_block(child["id"])
              except Exception as e:
                  print(f"    [!] Error scanning block {block_id}: {e}")

          print("--- Starting Targeted Recursive Backup ---")
          for root_id in ROOT_IDS:
              print(f"Searching ID: {root_id}")
              scan_block(root_id)

          print("\n--- Backup script finished ---")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "Nihad-BIT"
          git config user.email "nihadNV@proton.me"
          git add notion-backup/
          git diff --staged --quiet || (git commit -m "Auto-backup Notion CRM: $(date '+%Y-%m-%d %H:%M')" && git push)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
