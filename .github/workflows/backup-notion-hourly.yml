name: Notion API Backup (No Cookies)

permissions:
  contents: write  # Allows the workflow to push commits

on:
  schedule:
    - cron: '0 * * * *'  # Every hour at :00 – change to '*/5 * * * *' for 5-min testing
  workflow_dispatch:     # Manual trigger button in Actions tab

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install notion-client pandas

      - name: Backup Notion Databases (CSV + Summary MD) - Debug Mode
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}  # ← CHANGE TO YOUR SECRET NAME IF DIFFERENT
        run: |
          python - <<'EOF'
          import os
          from notion_client import Client
          from pathlib import Path
          import json

          notion = Client(auth=os.environ["NOTION_TOKEN"])

          database_ids = [
              "2fe86657637a805faab9000b4f8015b6",
              "2fe86657637a80c4957e000b695c0b7b"
          ]

          output_dir = Path("notion-backup")
          output_dir.mkdir(exist_ok=True)
          print(f"Output directory: {output_dir.absolute()}")

          for db_id in database_ids:
              print(f"\nProcessing database: {db_id}")
              try:
                  db = notion.databases.retrieve(database_id=db_id)
                  print(f"  Raw DB keys: {list(db.keys())}")
                  print(f"  Full DB response (truncated): {json.dumps(db, indent=2)[:1500]}...")

                  title = (db.get("title") or [{}])[0].get("plain_text", "Untitled_" + db_id[:8])
                  print(f"  Title: {title}")

                  properties = db.get("properties", {})
                  print(f"  Properties found: {list(properties.keys())}")

                  if not properties:
                      print("  WARNING: No properties returned — likely permissions issue!")
                      continue

                  # Query rows
                  query_result = notion.databases.query(database_id=db_id, page_size=5)
                  rows = query_result["results"]
                  print(f"  Rows fetched: {len(rows)} (has_more: {query_result.get('has_more')})")

                  if not rows:
                      print("  No rows found — database might be empty or filtered.")
                      continue

                  # Simple row extraction
                  data = []
                  for row in rows:
                      props = row.get("properties", {})
                      row_data = {
                          "Page ID": row["id"],
                          "Created": row["created_time"],
                          "Edited": row["last_edited_time"]
                      }
                      for name, prop in props.items():
                          val = prop.get(prop["type"])
                          if isinstance(val, dict):
                              if "name" in val: val = val["name"]
                              elif "plain_text" in val: val = val["plain_text"]
                              elif "start" in val: val = val["start"]
                          row_data[name] = val if val is not None else ""
                      data.append(row_data)

                  if data:
                      safe_title = "".join(c if c.isalnum() or c in " -" else "_" for c in title).strip("_")
                      csv_path = output_dir / f"{safe_title}.csv"
                      import pandas as pd
                      df = pd.DataFrame(data)
                      df.to_csv(csv_path, index=False)
                      print(f"  Saved CSV with {len(data)} rows: {csv_path.name}")

                      # Summary MD
                      md_content = f"# {title}\n\n**ID:** {db_id}\n**Rows sampled:** {len(rows)}\n**Properties:**\n"
                      for p in properties:
                          md_content += f"- {p}\n"
                      md_path = output_dir / f"{safe_title}_summary.md"
                      md_path.write_text(md_content)
                      print(f"  Saved summary: {md_path.name}")

              except Exception as e:
                  print(f"  ERROR on {db_id}: {str(e)}")

          print("\nBackup script finished.")
          EOF

      - name: Commit changes
        run: |
          git config user.name "Nihad-BIT"
          git config user.email "nihadNV@proton.me"
          git add notion-backup/
          git diff --staged --quiet || git commit -m "API Notion backup $(date '+%Y-%m-%d %H:%M')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
